<!DOCTYPE html>
<head>
  <title>{{ game_id }} - shot clock control</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'shotclock/css/style.css' %}" />
</head>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<body style="overflow: hidden">
  <div class="control-container">
    <div class="control-header">
      <h1 class="slogan">{{ game_id }}</h1>
      <h1>shot clock control</h1>
    </div>
    <div class="control-content">
      <div class="clock-display">
        <div id="clockTime">24.0</div>
      </div>
      <div class="row">
        <label
          >Set (s): <input id="secs" type="number" value="24" min="1" max="99"
        /></label>
      </div>
      <div class="row">
        <button id="apply">Apply</button>
        <button data-s="14">Set 14</button>
        <button data-s="24">Set 24</button>
      </div>
      <div class="row">
        <button id="start">Start</button>
        <button id="stop">Stop</button>
        <button id="reset">Reset</button>
      </div>
    </div>
  </div>
  <div class="spacebar-hint">Press space to toggle start/stop</div>
  <script>
    const proto = location.protocol === "https:" ? "wss" : "ws";
    const clockTimeEl = document.getElementById("clockTime");
    let running = false,
      serverRemaining = 24000,
      lastSync = performance.now();

    function fmt(ms) {
      const m = Math.floor(ms / 60000),
        s = Math.floor((ms % 60000) / 1000),
        d = Math.floor((ms % 1000) / 100);
      return `${m ? String(m).padStart(2, "0") + ":" : ""}${String(s).padStart(
        2,
        "0"
      )}.${d}`;
    }

    function updateClock() {
      let ms = serverRemaining;
      if (running) {
        const elapsed = performance.now() - lastSync;
        ms = Math.max(0, serverRemaining - elapsed);
      }
      clockTimeEl.textContent = fmt(ms);
      clockTimeEl.className = ms <= 5000 ? "warn" : "";
    }

    let ws = null;
    let wsConnected = false;
    window.clientName = "Control Panel";

    function connectWebSocket() {
      ws = new WebSocket(`${proto}://${location.host}/ws/clock/{{ game_id }}/`);
      window.ws = ws;

      ws.onopen = () => {
        wsConnected = true;
        window.wsConnected = true;
        window.updateDebugInfo && window.updateDebugInfo();
        updateConnectionStatus();
        enableControls();
      };

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === "tick") {
          serverRemaining = msg.remaining_ms;
          running = msg.running;
          window.running = running;
          lastSync = performance.now();
          updateClock(); // Update display only on tick
        }
      };

      ws.onclose = () => {
        wsConnected = false;
        window.wsConnected = false;
        window.updateDebugInfo && window.updateDebugInfo();
        updateConnectionStatus();
        disableControls();
        // Auto-reconnect after 2 seconds
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = () => {
        wsConnected = false;
        window.wsConnected = false;
        window.updateDebugInfo && window.updateDebugInfo();
        updateConnectionStatus();
        disableControls();
      };
    }
    window.connect = connectWebSocket;

    function enableControls() {
      const buttons = document.querySelectorAll("button");
      const inputs = document.querySelectorAll("input");
      buttons.forEach((btn) => {
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
      });
      inputs.forEach((input) => {
        input.disabled = false;
        input.style.opacity = "1";
      });
    }

    function disableControls() {
      const buttons = document.querySelectorAll("button:not(#reconnectBtn)");
      const inputs = document.querySelectorAll("input");
      buttons.forEach((btn) => {
        btn.disabled = true;
        btn.style.opacity = "0.5";
        btn.style.cursor = "not-allowed";
      });
      inputs.forEach((input) => {
        input.disabled = true;
        input.style.opacity = "0.5";
      });
    }

    function updateConnectionStatus() {}

    function sendCommand(cmd, value) {
      if (wsConnected && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(value ? { cmd, value } : { cmd }));
      }
    }

    document.getElementById("start").onclick = () => sendCommand("start");
    document.getElementById("stop").onclick = () => {
      running = false;
      sendCommand("stop");
    };
    document.getElementById("reset").onclick = () => sendCommand("reset");
    document.getElementById("apply").onclick = () => {
      const ms = Math.max(1, +document.getElementById("secs").value) * 1000;
      sendCommand("set", ms);
    };
    document.querySelectorAll("button[data-s]").forEach((b) => {
      b.onclick = () => sendCommand("set", +b.dataset.s * 1000);
    });

    // Keyboard shortcut for space bar to toggle start/stop
    document.addEventListener("keydown", (event) => {
      if (event.code === "Space") {
        event.preventDefault();
        if (running) {
          running = false;
          sendCommand("stop");
        } else {
          running = true;
          sendCommand("start");
        }
      }
    });

    // Initialize connection
    connectWebSocket();
    disableControls(); // Start with controls disabled
  </script>
  <script src="{% static 'shotclock/js/debug.js' %}"></script>
</body>
